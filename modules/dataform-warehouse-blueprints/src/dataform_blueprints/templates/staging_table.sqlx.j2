config {
  type: "{{ 'incremental' if incremental else 'table' }}",
  schema: "{{ dataset_id or 'staging' }}",
  name: "{{ table_name }}",
  {%- if partition_by %}
  bigquery: {
    partitionBy: "{{ partition_by }}",
    {%- if cluster_by %}
    clusterBy: {{ cluster_by | tojson }},
    {%- endif %}
  },
  {%- endif %}
  {%- if tags %}
  tags: {{ tags | tojson }},
  {%- endif %}
  {%- if description %}
  description: "{{ description }}",
  {%- endif %}
  {%- if dependencies %}
  dependencies: {{ dependencies | tojson }},
  {%- endif %}
}

-- Staging Table: {{ table_name }}
-- Layer: STAGING (Silver)
-- Purpose: Clean and standardize data from raw sources
-- Generated by: dataform-warehouse-blueprints v0.1.0

SELECT
{%- for column in columns %}
  {{ column }}{{ "," if not loop.last else "" }}
{%- endfor %}
  
FROM {{ source_table }}

{%- if incremental %}

${ when(incremental(), `
  WHERE updated_at > (SELECT MAX(updated_at) FROM ${self()})
`) }

{%- endif %}

